#!/bin/bash
previous_pwd=$(pwd)
node_bin="./node_modules/.bin"
package_name=$(npm view . name)
package_version=$(npm view . version)
global_object_name=$(node -e "console.log(require('./package.json').globalObjectName)")

function clean_dir() {
  find $1 -name "$2" -print0 | xargs -0 rm -rf
}

function clean() {
  echo "* clean $package_name"
  clean_dir build "*.js"
  clean_dir build "*.map"
  clean_dir spec "*.spec.coffee"
  clean_dir dist "*.*"
}

function build_source() {
  $node_bin/coffee -cmb -o build source
}

function license_dist() {
  ./bin/license-js LICENSE dist/$package_name.js dist/$package_name.min.js
}

function build_dist() {
  $node_bin/browserify -e index.js -s $global_object_name -o dist/$package_name.js
  $node_bin/uglifyjs dist/$package_name.js -o dist/$package_name.min.js
}

function build_specs() {
  $node_bin/boco-markdown-driven -c markdown-driven.json "docs/**/*.coffee.md"
}

function build() {
  echo "* build $package_name@$package_version"
  build_source
  build_dist
  build_specs
  build_readme
  license_dist
}

function build_readme() {
  cat ./docs/boco-socket-rpc.coffee.md > README.md
  echo -e "\n---\n" >> README.md
  cat LICENSE >> README.md
}

function run_specs() {
  echo "* run_specs $package_name"
  # run specs
  NODE_PATH=$NODE_PATH:. $node_bin/coffee ./spec/support/jasmine-runner.coffee
}

argv=("$*")
for arg in $argv; do eval ${arg}; done
cd $previous_pwd
